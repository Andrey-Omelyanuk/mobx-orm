!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("mobx")):"function"==typeof define&&define.amd?define(["exports","mobx"],t):t((e=e||self)["MobX-ORM"]={},e.mobx)}(this,function(e,t){"use strict";function n(e,t,n,o){var r,i=arguments.length,l=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,n,o);else for(var u=e.length-1;u>=0;u--)(r=e[u])&&(l=(i<3?r(l):i>3?r(t,n,l):r(t,n))||l);return i>3&&l&&Object.defineProperty(t,n,l),l}function o(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function r(e,t,n,o){return new(n||(n=Promise))(function(r,i){function l(e){try{a(o.next(e))}catch(e){i(e)}}function u(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(l,u)}a((o=o.apply(e,t||[])).next())})}function i(e,t){var n,o,r,i,l={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;l;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return l.label++,{value:i[1],done:!1};case 5:l.label++,o=i[1],i=[0];continue;case 7:i=l.ops.pop(),l.trys.pop();continue;default:if(!(r=(r=l.trys).length>0&&r[r.length-1])&&(6===i[0]||2===i[0])){l=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){l.label=i[1];break}if(6===i[0]&&l.label<r[1]){l.label=r[1],r=i;break}if(r&&l.label<r[2]){l.label=r[2],l.ops.push(i);break}r[2]&&l.ops.pop(),l.trys.pop();continue}i=t.call(e,l)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}}var l=function(){function e(){this.newId=0}return e.prototype.save=function(e){return r(this,void 0,void 0,function(){var t,n,o,r;return i(this,function(i){if(t=e.getModelDescription(),null===e.__id){for(n=0,o=t.ids;n<o.length;n++)r=o[n],e[r]=this.newId;this.newId++}return[2,Promise.resolve(e)]})})},e.prototype.delete=function(e){return r(this,void 0,void 0,function(){var t,n,o,r;return i(this,function(i){for(t=e.getModelDescription(),n=0,o=t.ids;n<o.length;n++)r=o[n],e[r]=null;return[2,Promise.resolve(e)]})})},e.prototype.load=function(){return r(this,void 0,void 0,function(){return i(this,function(e){throw new Error("Not Implemented for DefaultAdapter")})})},e}(),u=new(function(){function e(){this.debug=!1,this.models={},this.field_types={}}return e.prototype.registerModel=function(e){if(this.models[e])throw new Error('Model "'+e+'" already registered.');this.models[e]={ids:[],fields:{},objects:{},adapter:new l},this.models[e].objects=t.observable(this.models[e].objects)},e.prototype.registerFieldType=function(e,t){if(this.field_types[e])throw new Error('Field type "'+e+'" already registered.');this.field_types[e]=t},e.prototype.registerModelField=function(e,t,n,o,r,i){void 0===o&&(o={}),void 0===r&&(r=null),void 0===i&&(i=null),this.models[e]||this.registerModel(e);var l=this.models[e];if(l.fields[n])throw'Field "'+n+'" on "'+e+'" already registered.';l.fields[n]={type:t,settings:o,serialize:r,deserialize:i}},e.prototype.registerId=function(e,t){this.models[e]||this.registerModel(e);var n=this.models[e];if(-1!=n.ids.indexOf(t))throw'Id "'+t+'" in model "'+e+'" already registered.';n.ids.push(t)},e.prototype.inject=function(e){var t=e.getModelDescription();if(null===e.__id)throw new Error("Object should have id!");if(t.objects[e.__id])throw new Error('Object with id "'+e.__id+'" already exist in the store (model: "'+e.getModelName()+'")');t.objects[e.__id]=e},e.prototype.eject=function(e){if(null!==e.__id){var t=e.getModelDescription();if(!t.objects[e.__id])throw new Error('Object with id "'+e.__id+'" not exist in the store (model: '+e.getModelName()+'")');delete t.objects[e.__id]}},e.prototype.clear=function(){for(var e=0,t=Object.keys(this.models);e<t.length;e++){var n=t[e];this.clearModel(n)}this.models={}},e.prototype.clearModel=function(e){var t=this.models[e];if(t)for(var n=0,o=Object.values(t.objects);n<o.length;n++)for(var r=o[n],i=0,l=t.ids;i<l.length;i++){r[l[i]]=null}},e.prototype.getId=function(e,t){for(var n="",o=0,r=t;o<r.length;o++){var i=r[o];if(null===e[i]||void 0===e[i])return null;n+=e[i]+" :"}return n},n([t.observable,o("design:type",Object)],e.prototype,"models",void 0),e}()),a=function(){function e(e){this._init_data=e}return e.get=function(e){return this.getModelDescription().objects[e]},e.all=function(){var e=this.getModelDescription();return Object.values(e.objects)},e.load=function(e,t,n,o){return void 0===e&&(e={}),void 0===t&&(t={}),void 0===n&&(n=0),void 0===o&&(o=0),r(this,void 0,void 0,function(){return i(this,function(r){return[2,this.getModelDescription().adapter.load(this,e,t,n,o)]})})},e.getModelName=function(){return this.prototype.constructor.name},e.getModelDescription=function(){var e=this.getModelName(),t=u.models[e];if(void 0===t)throw Error("Description for '"+e+"' is not exist. Maybe, you called store.clear after model declaration.");return t},Object.defineProperty(e.prototype,"__id",{get:function(){return u.getId(this,this.getModelDescription().ids)},enumerable:!0,configurable:!0}),e.prototype.getModelName=function(){return this.constructor.name},e.prototype.getModelDescription=function(){var e=this.getModelName(),t=u.models[e];if(void 0===t)throw Error("Description for '"+e+"' is not exist. Maybe, you called store.clear after model declaration.");return t},e.prototype.save=function(){return r(this,void 0,void 0,function(){return i(this,function(e){return[2,this.getModelDescription().adapter.save(this)]})})},e.prototype.delete=function(){return r(this,void 0,void 0,function(){return i(this,function(e){return[2,this.getModelDescription().adapter.delete(this)]})})},n([t.computed({keepAlive:!0}),o("design:type",String),o("design:paramtypes",[])],e.prototype,"__id",null),e}();var s="id";u.registerFieldType(s,function(e,n,o){t.intercept(o,n,function(e){if(null!==e.newValue&&null!==o[n])throw new Error("You cannot change id field: "+n);if(null!==o[n]&&null===e.newValue)try{u.eject(o)}catch(e){if(e.name!=='Object with id "'+o.__id+'" not exist in the store (model: '+o.getModelName()+'")')throw e}return e}),t.observe(o,n,function(e){null!==o.__id&&u.inject(o)}),void 0===o[n]&&(o[n]=null)});var c="field";u.registerFieldType(c,function(e,t,n){});var d="foreign";u.registerFieldType(d,function(e,n,o){var r=!1,i=u.models[e].fields[n].settings.foreign_model_name,l=u.models[e].fields[n].settings.foreign_id_field_names;t.autorun(function(){var e=u.getId(o,l);if(u.models[i]){var t=u.models[i].objects[e];o[n]=t||null}}),t.intercept(o,n,function(e){if(null!==e.newValue&&(!e.newValue.constructor||e.newValue.constructor.name!=i))throw new Error('You can set only instance of "'+i+'" or null');return e}),t.observe(o,n,function(e){if(e.newValue!==e.oldValue&&!r){r=!0;try{if(null===e.newValue)for(var t=0;t<l.length;t++)o[l[t]]=null;else{var n=e.newValue.getModelDescription();for(t=0;t<l.length;t++)o[l[t]]=e.newValue[n.ids[t]]}r=!1}catch(i){if(null===e.oldValue)for(t=0;t<l.length;t++)o[l[t]]=null;else for(n=e.newValue.getModelDescription(),t=0;t<l.length;t++)o[l[t]]=e.oldValue[n.ids[t]];throw r=!1,i}}}),void 0===o[n]&&(o[n]=null)}),u.registerFieldType("one",function(e,n,o){var r=u.models[e].fields[n].settings.remote_model_name;u.models[e].fields[n].settings.foreign_field_on_remote_model,t.intercept(o,n,function(e){if(null!==e.newValue&&(!e.newValue.constructor||e.newValue.constructor.name!==r))throw new Error('You can set only instance of "'+r+'" or null');return e}),o[n]=null}),u.registerFieldType("many",function(e,t,n){n[t]=[]});var f="number";u.registerFieldType(f,function(e,n,o){t.intercept(o,n,function(e){if(null!==e.newValue&&(e.newValue!==Number(e.newValue)||e.newValue%1!=0))throw new Error("Field can be only integer or null.");return e})});var p="float";u.registerFieldType(p,function(e,n,o){t.intercept(o,n,function(e){if(null!==e.newValue&&e.newValue!==Number(e.newValue))throw new Error("Field can be only float or null.");return e})});var m="datetime";u.registerFieldType(m,function(e,n,o){t.intercept(o,n,function(e){if(null!==e.newValue&&(("string"==typeof e.newValue||e.newValue instanceof String)&&(e.newValue=Date.parse(e.newValue),isNaN(e.newValue)||(e.newValue=new Date(e.newValue))),!(e.newValue instanceof Date)))throw new Error("Field can be only Date or null.");return e})});var v="boolean";u.registerFieldType(v,function(e,n,o){t.intercept(o,n,function(e){return null!==e.newValue&&(e.newValue=Boolean(e.newValue)),e})}),e.DefaultAdapter=l,e.Model=a,e.boolean=function(e,n){var o="Function"==e.constructor.name?e.prototype.constructor.name:e.constructor.name;u.registerModelField(o,v,n),t.observable(e,n)},e.datetime=function(e,n){var o="Function"===e.constructor.name?e.prototype.constructor.name:e.constructor.name;u.registerModelField(o,m,n,{},function(e){return new Date(e)},function(e){return e.toISOString()}),t.observable(e,n)},e.field=function(e,n){var o="Function"===e.constructor.name?e.prototype.constructor.name:e.constructor.name;u.registerModelField(o,c,n),t.observable(e,n)},e.float=function(e,n){var o="Function"===e.constructor.name?e.prototype.constructor.name:e.constructor.name;u.registerModelField(o,p,n),t.observable(e,n)},e.foreign=function(e){for(var n=[],o=1;o<arguments.length;o++)n[o-1]=arguments[o];return function(o,r){var i=o.getModelName();"function"==typeof e&&(e="Function"==e.constructor.name?e.prototype.constructor.name:e.constructor.name),u.registerModelField(i,d,r,{foreign_model_name:e,foreign_id_field_names:n.length?n:[r+"_id"]}),t.observable(o,r)}},e.id=function(e,n){u.registerModelField(e.getModelName(),s,n),u.registerId(e.getModelName(),n),t.observable(e,n)},e.many=function(e,n){return function(o,r){var i=o.getModelName();"function"==typeof e&&(e="Function"==e.constructor.name?e.prototype.constructor.name:e.constructor.name),u.models[i]||u.registerModel(i),u.models[e]||u.registerModel(e),u.registerModelField(i,"many",r,{remote_model_name:e,foreign_field_on_remote_model:n}),t.observable(o,r);for(var l=function(e){t.observe(e,n,function(t){t.oldValue&&(t.oldValue[r]=null),t.newValue&&(t.newValue[r]=e)})},a=0,s=Object.values(u.models[e].objects);a<s.length;a++)l(s[a]);t.observe(u.models[e].objects,function(e){switch(e.type){case"add":e.newValue[n]&&e.newValue[n][r].push(e.newValue),t.observe(e.newValue,n,function(t){if(t.oldValue){var n=t.oldValue,o=n[r].indexOf(e.newValue);o>-1&&n[r].splice(o,1)}t.newValue&&t.newValue[r].push(e.newValue)});break;case"remove":var o=e.oldValue[n];if(o){var i=o[r].indexOf(e.oldValue);i>-1&&o[r].splice(i,1)}}})}},e.model=function(e){for(var t=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var o=function(){return e.apply(this,t)};o.__proto__=e.__proto__,o.prototype=e.prototype;var r=e.getModelName(),i=e.getModelDescription(),l=new o,a=l._init_data?l._init_data:{};for(var s in delete l._init_data,i.fields)void 0!==l[s]&&void 0===a[s]&&(a[s]=l[s]);for(var s in i.fields){var c=i.fields[s].type;u.field_types[c](r,s,l)}if(a)for(var s in a)l[s]=a[s];return l},n=0,o=Object.getOwnPropertyNames(e);n<o.length;n++){var r=o[n];null==t[r]&&(t[r]=e[r])}return t.__proto__=e.__proto__,t.prototype=e.prototype,t},e.number=function(e,n){var o="Function"==e.constructor.name?e.prototype.constructor.name:e.constructor.name;u.registerModelField(o,f,n),t.observable(e,n)},e.one=function(e,n){return function(o,r){var i=o.getModelName();"function"==typeof e&&(e="Function"==e.constructor.name?e.prototype.constructor.name:e.constructor.name),u.models[i]||u.registerModel(i),u.models[e]||u.registerModel(e),u.registerModelField(i,"one",r,{remote_model_name:e,foreign_field_on_remote_model:n}),t.observable(o,r);for(var l=function(e){t.observe(e,n,function(t){t.oldValue&&(t.oldValue[r]=null),t.newValue&&(t.newValue[r]=e)})},a=0,s=Object.values(u.models[e].objects);a<s.length;a++)l(s[a]);t.observe(u.models[e].objects,function(e){switch(e.type){case"add":e.newValue[n]&&(e.newValue[n][r]=e.newValue),t.observe(e.newValue,n,function(t){t.oldValue&&(t.oldValue[r]=null),t.newValue&&(t.newValue[r]=e.newValue)});break;case"remove":var o=e.oldValue[n];o&&(o[r]=null)}})}},e.store=u,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=mobx-orm.js.map
