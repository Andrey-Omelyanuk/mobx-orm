!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("mobx")):"function"==typeof define&&define.amd?define(["exports","mobx"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["MobX-ORM"]={},e.mobx)}(this,(function(e,t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function r(e,t,r,n){var o,i=arguments.length,l=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(l=(i<3?o(l):i>3?o(t,r,l):o(t,r))||l);return i>3&&l&&Object.defineProperty(t,r,l),l}function n(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function o(e,t,r,n){return new(r||(r=Promise))((function(o,i){function l(e){try{u(n.next(e))}catch(e){i(e)}}function a(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(l,a)}u((n=n.apply(e,t||[])).next())}))}function i(e,t){var r,n,o,i,l={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;l;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return l.label++,{value:i[1],done:!1};case 5:l.label++,n=i[1],i=[0];continue;case 7:i=l.ops.pop(),l.trys.pop();continue;default:if(!(o=l.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){l=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){l.label=i[1];break}if(6===i[0]&&l.label<o[1]){l.label=o[1],o=i;break}if(o&&l.label<o[2]){l.label=o[2],l.ops.push(i);break}o[2]&&l.ops.pop(),l.trys.pop();continue}i=t.call(e,l)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function l(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}var a=function(){function e(e,r,n,l,a){var u=this;Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"filters",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"order_by",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"page",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"page_size",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"is_ready",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"autoUpdateDisposer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),t.makeObservable(this),this.autoUpdateDisposer=t.autorun((function(){return o(u,void 0,void 0,(function(){var t,r;return i(this,(function(n){switch(n.label){case 0:this.is_ready=!1,n.label=1;case 1:return n.trys.push([1,3,,4]),t=this,[4,e.adapter.load(this.filters,this.order_by,this.page_size,this.page*this.page_size)];case 2:return t.items=n.sent(),[3,4];case 3:return r=n.sent(),this.error=r,[3,4];case 4:return this.is_ready=!0,[2]}}))}))}))}return Object.defineProperty(e.prototype,"destroy",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.autoUpdateDisposer()}}),r([t.observable,n("design:type",Array)],e.prototype,"items",void 0),r([t.observable,n("design:type",Object)],e.prototype,"filters",void 0),r([t.observable,n("design:type",Array)],e.prototype,"order_by",void 0),r([t.observable,n("design:type",Number)],e.prototype,"page",void 0),r([t.observable,n("design:type",Number)],e.prototype,"page_size",void 0),r([t.observable,n("design:type",Boolean)],e.prototype,"is_ready",void 0),r([t.observable,n("design:type",String)],e.prototype,"error",void 0),e}(),u=function(){function e(e){Object.defineProperty(this,"_init_data",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"disposers",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),this._init_data=e||{}}return Object.defineProperty(e,"load",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,r,n){return void 0===e&&(e={}),void 0===t&&(t={}),void 0===r&&(r=0),void 0===n&&(n=50),new a(this,e,t,r,n)}}),Object.defineProperty(e,"clearCache",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e,t,r,n;try{for(var o=l(this.cache.values()),i=o.next();!i.done;i=o.next()){var a=i.value;try{for(var u=(r=void 0,l(this.ids)),c=u.next();!c.done;c=u.next()){a[c.value]=null}}catch(e){r={error:e}}finally{try{c&&!c.done&&(n=u.return)&&n.call(u)}finally{if(r)throw r.error}}}}catch(t){e={error:t}}finally{try{i&&!i.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}}}),Object.defineProperty(e,"__id",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var r,n,o="";try{for(var i=l(t),a=i.next();!a.done;a=i.next()){var u=a.value;if(null===e[u]||void 0===e[u])return null;o+=e[u]+" :"}}catch(e){r={error:e}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return o}}),Object.defineProperty(e.prototype,"__id",{get:function(){return e.__id(this,this.model.ids)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"model",{get:function(){return this.constructor},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"save",{enumerable:!1,configurable:!0,writable:!0,value:function(){return o(this,void 0,void 0,(function(){return i(this,(function(e){return[2,this.model.adapter.save(this)]}))}))}}),Object.defineProperty(e.prototype,"delete",{enumerable:!1,configurable:!0,writable:!0,value:function(){return o(this,void 0,void 0,(function(){var e,t,r,n;return i(this,(function(o){switch(o.label){case 0:return[4,this.model.adapter.delete(this)];case 1:o.sent();try{for(e=l(this.model.ids),t=e.next();!t.done;t=e.next())this[t.value]=null}catch(e){r={error:e}}finally{try{t&&!t.done&&(n=e.return)&&n.call(e)}finally{if(r)throw r.error}}return[2]}}))}))}}),Object.defineProperty(e.prototype,"inject",{enumerable:!1,configurable:!0,writable:!0,value:function(){if(null===this.__id)throw new Error("Object should have id!");if(this.model.cache.has(this.__id))throw new Error('Object with id "'+this.__id+'" already exist in the cache of model: "'+this.model.name+'")');this.model.cache.set(this.__id,this)}}),Object.defineProperty(e.prototype,"eject",{enumerable:!1,configurable:!0,writable:!0,value:function(){if(null!==this.__id){if(!this.model.cache.has(this.__id))throw new Error('Object with id "'+this.__id+'" not exist in the cache of model: '+this.model.name+'")');this.model.cache.delete(this.__id)}}}),r([t.computed,n("design:type",String),n("design:paramtypes",[])],e.prototype,"__id",null),r([t.action,n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",void 0)],e.prototype,"inject",null),r([t.action,n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",void 0)],e.prototype,"eject",null),e}();var c={},s=function(){function e(e,t){Object.defineProperty(this,"cls",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"store_name",{enumerable:!0,configurable:!0,writable:!0,value:t}),c[t]={}}return Object.defineProperty(e.prototype,"save",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return o(this,void 0,void 0,(function(){var t,r,n,o,a,u,s,d,f,p,b,h;return i(this,(function(i){if(null===e.__id){t=[0];try{for(r=l(Object.keys(c[this.store_name])),n=r.next();!n.done;n=r.next())o=n.value,t.push(parseInt(o))}catch(e){f={error:e}}finally{try{n&&!n.done&&(p=r.return)&&p.call(r)}finally{if(f)throw f.error}}a=Math.max.apply(null,t);try{for(u=l(e.model.ids),s=u.next();!s.done;s=u.next())d=s.value,e[d]=a+1}catch(e){b={error:e}}finally{try{s&&!s.done&&(h=u.return)&&h.call(u)}finally{if(b)throw b.error}}c[this.store_name][e.__id]=e}else c[this.store_name][e.__id]=e;return[2,e]}))}))}}),Object.defineProperty(e.prototype,"delete",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return o(this,void 0,void 0,(function(){return i(this,(function(t){return delete c[this.store_name][e.__id],[2]}))}))}}),Object.defineProperty(e.prototype,"load",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,r,n){throw"Not implemented"}}),e}();var d=function(){function e(e,t,r){Object.defineProperty(this,"cls",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"http",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"api",{enumerable:!0,configurable:!0,writable:!0,value:r})}return Object.defineProperty(e.prototype,"save",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return o(this,void 0,void 0,(function(){var t,r;return i(this,(function(n){switch(n.label){case 0:for(r in t={},e.model.fields)null!==e[r]&&(t[r]=e[r]);return null!==e.__id?[3,2]:[4,this.http.post(this.api+"/",t)];case 1:for(r in t=n.sent(),e.model.fields)e[r]=t[r];return[3,4];case 2:return[4,this.http.put(this.api+"/"+e.__id+"/",t)];case 3:for(r in t=n.sent(),e.model.fields)e.model.ids.includes(r)||(e[r]=t[r]);n.label=4;case 4:return[2,e]}}))}))}}),Object.defineProperty(e.prototype,"delete",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return o(this,void 0,void 0,(function(){return i(this,(function(t){return[2,this.http.delete(this.api+"/"+e.__id+"/")]}))}))}}),Object.defineProperty(e.prototype,"load",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,r,n){return o(this,void 0,void 0,(function(){var e,t,r,n,o,a,u;return i(this,(function(i){switch(i.label){case 0:return"",[4,this.http.get(this.api+"/?")];case 1:e=i.sent(),t=[];try{for(r=l(e),n=r.next();!n.done;n=r.next())o=n.value,t.push(new this.cls(o))}catch(e){a={error:e}}finally{try{n&&!n.done&&(u=r.return)&&u.call(r)}finally{if(a)throw a.error}}return[2,t]}}))}))}}),e}();function f(e,r){var n;t.extendObservable(e,((n={})[r]=null,n)),t.intercept(e,r,(function(t){if(null!==t.newValue&&null!==e[r])throw new Error("You cannot change id field: "+r+". "+e[r]+" to "+t.newValue);if(null!==e[r]&&null===t.newValue)try{e.eject()}catch(t){var n='Object with id "'+e.__id+'" not exist in the model cache: '+e.model.name+'")';if(t.name!==n)throw t}return t})),t.observe(e,r,(function(t){null!==e.__id&&e.inject()}))}function p(e,r){var n;t.extendObservable(e,((n={})[r]=null,n))}function b(e,r){var n,o=!1,i=e.model.fields[r].settings,a=i.foreign_model,u=i.foreign_ids_names;t.extendObservable(e,((n={})[r]=null,n)),t.reaction((function(){var t=a.__id(e,u);return t?a.cache.get(t):null}),(function(t,n,o){e[r]=t||null})),t.intercept(e,r,(function(e){if(null!==e.newValue&&(!e.newValue.constructor||e.newValue.constructor!=a.__proto__))throw new Error('You can set only instance of "'+a.__proto__.name+'" or null');return e})),t.observe(e,r,(function(t){var r,n,a=t.newValue,c=t.oldValue;if(a!==c&&!o){o=!0;try{if(null===t.newValue)try{for(var s=l(u),d=s.next();!d.done;d=s.next()){var f=d.value;e[f]=null}}catch(e){r={error:e}}finally{try{d&&!d.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}else for(var p=t.newValue.model.ids,b=0;b<u.length;b++)e[u[b]]!=t.newValue[p[b]]&&(e[u[b]]=t.newValue[p[b]]);o=!1}catch(r){if(null===t.oldValue)for(b=0;b<u.length;b++)e[u[b]]=null;else for(p=t.oldValue.model.ids,b=0;b<u.length;b++)e[u[b]]=t.oldValue[p[b]];throw o=!1,r}i.one&&(c&&(c[i.one]=null),a&&(a[i.one]=e))}}))}function h(e,r){var n,o=!1,i=e.model.fields[r].settings.remote_model,a=e.model.fields[r].settings.remote_foreign_ids_names;t.extendObservable(e,((n={})[r]=null,n)),t.intercept(e,r,(function(e){if(null!==e.newValue&&(!e.newValue.constructor||e.newValue.constructor!==i.__proto__))throw new Error('You can set only instance of "'+i.__proto__.name+'" or null');return e})),t.observe(e,r,(function(t){var r,n,i=t.oldValue,u=t.newValue;if(u!==i&&!o){o=!0;try{if(i)try{for(var c=l(a),s=c.next();!s.done;s=c.next()){i[s.value]=null}}catch(e){r={error:e}}finally{try{s&&!s.done&&(n=c.return)&&n.call(c)}finally{if(r)throw r.error}}if(u)for(var d=e.model.ids,f=0;f<a.length;f++)u[a[f]]!=e[d[f]]&&(u[a[f]]=e[d[f]]);o=!1}catch(e){}}}))}function v(e,r){var n;e.model.fields[r].settings.remote_model;var o=e.model.fields[r].settings.remote_foreign_ids_names;t.extendObservable(e,((n={})[r]=[],n)),t.intercept(e[r],(function(e){return e})),t.observe(e[r],(function(t){var r,n,i,a,u,c;if("splice"===t.type){var s=t.removed,d=t.added;!0;try{try{for(var f=l(s),p=f.next();!p.done;p=f.next()){var b=p.value;try{for(var h=(i=void 0,l(o)),v=h.next();!v.done;v=h.next()){b[v.value]=null}}catch(e){i={error:e}}finally{try{v&&!v.done&&(a=h.return)&&a.call(h)}finally{if(i)throw i.error}}}}catch(e){r={error:e}}finally{try{p&&!p.done&&(n=f.return)&&n.call(f)}finally{if(r)throw r.error}}var y=e.model.ids;try{for(var _=l(d),m=_.next();!m.done;m=_.next())for(var g=m.value,w=0;w<o.length;w++)g[o[w]]!=e[y[w]]&&(g[o[w]]=e[y[w]])}catch(e){u={error:e}}finally{try{m&&!m.done&&(c=_.return)&&c.call(_)}finally{if(u)throw u.error}}!1}catch(e){}}}))}e.LocalAdapter=s,e.Model=u,e.Query=a,e.RestAdapter=d,e.field=function(e,t){var r=e.constructor;void 0===r.fields&&(r.fields={}),r.fields[t]={decorator:p}},e.foreign=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];return function(r,n){var o=r.constructor;void 0===o.fields&&(o.fields={}),o.fields[n]={decorator:b,settings:{foreign_model:e,foreign_ids_names:t.length?t:[n+"_id"]}}}},e.id=function(e,t){var r=e.constructor;void 0===r.fields&&(r.fields={}),void 0===r.ids&&(r.ids=[]),r.fields[t]={decorator:f},r.ids.push(t)},e.local=function(e){return function(t){var r=new s(t,e);t.__proto__.adapter=r}},e.many=function(e){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];return function(n,o){var i=n.prototype.constructor;void 0===i.fields&&(i.fields={}),r=r.length?r:[i.name.toLowerCase()+"_id"],i.fields[o]={decorator:v,settings:{remote_model:e,remote_foreign_ids_names:r}},t.observe(e.cache,(function(e){var n;switch(e.type){case"add":(n=e.newValue).disposers.set("many "+o,t.autorun((function(){var e=i.cache.get(i.__id(n,r));e&&(-1==e[o].indexOf(n)&&t.runInAction((function(){e[o].push(n)})))})));break;case"delete":(n=e.oldValue).disposers.get("many "+o)&&(n.disposers.get("many "+o)(),n.disposers.delete("many "+o));var l=i.cache.get(i.__id(n,r));if(l){var a=l[o].indexOf(n);a>-1&&t.runInAction((function(){l[o].splice(a,1)}))}}}))}},e.model=function(e){var r=e;r.cache=t.observable(new Map);var n=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var o=function(){return r.apply(this,e)};o.__proto__=r,o.prototype=r.prototype;var i=new o;for(var l in t.makeObservable(i),i.model.fields)void 0===i._init_data[l]&&void 0!==i[l]&&(i._init_data[l]=i[l]);for(var l in i.model.fields)i.model.fields[l].decorator(i,l);return t.runInAction((function(){for(var e in i._init_data)i[e]=i._init_data[e]})),i};return n.__proto__=r,n.prototype=r.prototype,n},e.one=function(e){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];return function(n,o){var i=n.prototype.constructor;void 0===i.fields&&(i.fields={}),r=r.length?r:[i.name.toLowerCase()+"_id"],i.fields[o]={decorator:h,settings:{remote_model:e,remote_foreign_ids_names:r}},t.observe(e.cache,(function(e){var n;switch(e.type){case"add":(n=e.newValue).disposers.set("one "+o,t.autorun((function(){var e=i.cache.get(i.__id(n,r));e&&t.runInAction((function(){e[o]=n}))})));break;case"delete":(n=e.oldValue).disposers.get("one "+o)&&(n.disposers.get("one "+o)(),n.disposers.delete("one "+o));var l=i.cache.get(i.__id(n,r));l&&t.runInAction((function(){l[o]=null}))}}))}},e.rest=function(e,t){return function(r){var n=new d(r,e,t);r.__proto__.adapter=n}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=mobx-orm.js.map
