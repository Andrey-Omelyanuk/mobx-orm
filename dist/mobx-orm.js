!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("mobx")):"function"==typeof define&&define.amd?define(["exports","mobx"],t):t((e=e||self)["MobX-ORM"]={},e.mobx)}(this,function(e,t){"use strict";function o(e,t,o,n){var r,i=arguments.length,l=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,o,n);else for(var u=e.length-1;u>=0;u--)(r=e[u])&&(l=(i<3?r(l):i>3?r(t,o,l):r(t,o))||l);return i>3&&l&&Object.defineProperty(t,o,l),l}function n(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function r(e,t,o,n){return new(o||(o=Promise))(function(r,i){function l(e){try{a(n.next(e))}catch(e){i(e)}}function u(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){e.done?r(e.value):new o(function(t){t(e.value)}).then(l,u)}a((n=n.apply(e,t||[])).next())})}function i(e,t){var o,n,r,i,l={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(o)throw new TypeError("Generator is already executing.");for(;l;)try{if(o=1,n&&(r=2&i[0]?n.return:i[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,i[1])).done)return r;switch(n=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return l.label++,{value:i[1],done:!1};case 5:l.label++,n=i[1],i=[0];continue;case 7:i=l.ops.pop(),l.trys.pop();continue;default:if(!(r=(r=l.trys).length>0&&r[r.length-1])&&(6===i[0]||2===i[0])){l=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){l.label=i[1];break}if(6===i[0]&&l.label<r[1]){l.label=r[1],r=i;break}if(r&&l.label<r[2]){l.label=r[2],l.ops.push(i);break}r[2]&&l.ops.pop(),l.trys.pop();continue}i=t.call(e,l)}catch(e){i=[6,e],n=0}finally{o=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}}var l=function(){function e(){this.newId=0}return e.prototype.save=function(e){return r(this,void 0,void 0,function(){var t,o,n,r;return i(this,function(i){if(t=e.getModelDescription(),null===e.__id){for(o=0,n=t.ids;o<n.length;o++)r=n[o],e[r]=this.newId;this.newId++}return[2,Promise.resolve(e)]})})},e.prototype.delete=function(e){return r(this,void 0,void 0,function(){var t,o,n,r;return i(this,function(i){for(t=e.getModelDescription(),o=0,n=t.ids;o<n.length;o++)r=n[o],e[r]=null;return[2,Promise.resolve(e)]})})},e.prototype.load=function(){return r(this,void 0,void 0,function(){return i(this,function(e){throw new Error("Not Implemented for DefaultAdapter")})})},e}(),u=new(function(){function e(){this.debug=!1,this.models={},this.field_types={}}return e.prototype.registerModel=function(e){if(this.models[e])throw new Error('Model "'+e+'" already registered.');this.models[e]={ids:[],fields:{},objects:{},adapter:new l},this.models[e].objects=t.observable(this.models[e].objects)},e.prototype.registerFieldType=function(e,t){if(this.field_types[e])throw new Error('Field type "'+e+'" already registered.');this.field_types[e]=t},e.prototype.registerModelField=function(e,t,o,n,r,i){void 0===n&&(n={}),void 0===r&&(r=null),void 0===i&&(i=null),this.models[e]||this.registerModel(e);var l=this.models[e];if(l.fields[o])throw'Field "'+o+'" on "'+e+'" already registered.';l.fields[o]={type:t,settings:n,serialize:r,deserialize:i}},e.prototype.registerId=function(e,t){this.models[e]||this.registerModel(e);var o=this.models[e];if(-1!=o.ids.indexOf(t))throw'Id "'+t+'" in model "'+e+'" already registered.';o.ids.push(t)},e.prototype.inject=function(e){var t=e.getModelDescription();if(null===e.__id)throw new Error("Object should have id!");if(t.objects[e.__id])throw new Error('Object with id "'+e.__id+'" already exist in the store (model: "'+e.getModelName()+'")');t.objects[e.__id]=e},e.prototype.eject=function(e){if(null!==e.__id){var t=e.getModelDescription();if(!t.objects[e.__id])throw new Error('Object with id "'+e.__id+'" not exist in the store (model: '+e.getModelName()+'")');delete t.objects[e.__id]}},e.prototype.clear=function(){for(var e=0,t=Object.keys(this.models);e<t.length;e++){var o=t[e];this.clearModel(o)}this.models={}},e.prototype.clearModel=function(e){var t=this.models[e];if(t)for(var o=0,n=Object.values(t.objects);o<n.length;o++)for(var r=n[o],i=0,l=t.ids;i<l.length;i++){r[l[i]]=null}},e.prototype.getId=function(e,t){for(var o="",n=0,r=t;n<r.length;n++){var i=r[n];if(null===e[i]||void 0===e[i])return null;o+=e[i]+" :"}return o},o([t.observable,n("design:type",Object)],e.prototype,"models",void 0),e}()),a=function(){function e(e){this._init_data=e}return e.get=function(e){return this.getModelDescription().objects[e]},e.all=function(){var e=this.getModelDescription();return Object.values(e.objects)},e.load=function(e,t,o,n){return void 0===e&&(e={}),void 0===t&&(t={}),void 0===o&&(o=0),void 0===n&&(n=0),r(this,void 0,void 0,function(){return i(this,function(r){return[2,this.getModelDescription().adapter.load(this,e,t,o,n)]})})},e.getModelName=function(){return this.prototype.constructor.name},e.getModelDescription=function(){var e=this.getModelName(),t=u.models[e];if(void 0===t)throw Error("Description for '"+e+"' is not exist. Maybe, you called store.clear after model declaration.");return t},Object.defineProperty(e.prototype,"__id",{get:function(){return u.getId(this,this.getModelDescription().ids)},enumerable:!0,configurable:!0}),e.prototype.getModelName=function(){return this.constructor.name},e.prototype.getModelDescription=function(){var e=this.getModelName(),t=u.models[e];if(void 0===t)throw Error("Description for '"+e+"' is not exist. Maybe, you called store.clear after model declaration.");return t},e.prototype.save=function(){return r(this,void 0,void 0,function(){return i(this,function(e){return[2,this.getModelDescription().adapter.save(this)]})})},e.prototype.delete=function(){return r(this,void 0,void 0,function(){return i(this,function(e){return[2,this.getModelDescription().adapter.delete(this)]})})},o([t.computed({keepAlive:!0}),n("design:type",String),n("design:paramtypes",[])],e.prototype,"__id",null),e}();var s="id";u.registerFieldType(s,function(e,o,n){t.intercept(n,o,function(e){if(null!==e.newValue&&null!==n[o])throw new Error("You cannot change id field: "+o);if(null!==n[o]&&null===e.newValue)try{u.eject(n)}catch(e){if(e.name!=='Object with id "'+n.__id+'" not exist in the store (model: '+n.getModelName()+'")')throw e}return e}),t.observe(n,o,function(e){null!==n.__id&&u.inject(n)}),void 0===n[o]&&(n[o]=null)});var c="field";u.registerFieldType(c,function(e,t,o){});var d="foreign";u.registerFieldType(d,function(e,o,n){var r=!1,i=u.models[e].fields[o].settings.foreign_model_name,l=u.models[e].fields[o].settings.foreign_id_field_names;t.autorun(function(){var e=u.getId(n,l);if(u.models[i]){var t=u.models[i].objects[e];n[o]=t||null}}),t.intercept(n,o,function(e){if(null!==e.newValue&&(!e.newValue.constructor||e.newValue.constructor.name!=i))throw new Error('You can set only instance of "'+i+'" or null');return e}),t.observe(n,o,function(e){if(e.newValue!==e.oldValue&&!r){r=!0;try{if(null===e.newValue)for(var t=0;t<l.length;t++)n[l[t]]=null;else{var o=e.newValue.getModelDescription();for(t=0;t<l.length;t++)n[l[t]]=e.newValue[o.ids[t]]}r=!1}catch(i){if(null===e.oldValue)for(t=0;t<l.length;t++)n[l[t]]=null;else for(o=e.newValue.getModelDescription(),t=0;t<l.length;t++)n[l[t]]=e.oldValue[o.ids[t]];throw r=!1,i}}}),void 0===n[o]&&(n[o]=null)}),u.registerFieldType("one",function(e,o,n){var r=u.models[e].fields[o].settings.remote_model_name;u.models[e].fields[o].settings.foreign_field_on_remote_model,t.intercept(n,o,function(e){if(null!==e.newValue&&(!e.newValue.constructor||e.newValue.constructor.name!==r))throw new Error('You can set only instance of "'+r+'" or null');return e}),n[o]=null}),u.registerFieldType("many",function(e,t,o){o[t]=[]});var f="number";u.registerFieldType(f,function(e,o,n){t.intercept(n,o,function(e){if(null!==e.newValue&&(e.newValue!==Number(e.newValue)||e.newValue%1!=0))throw new Error("Field can be only integer or null.");return e})});var p="float";u.registerFieldType(p,function(e,o,n){t.intercept(n,o,function(e){if(null!==e.newValue&&e.newValue!==Number(e.newValue))throw new Error("Field can be only float or null.");return e})});var m="datetime";u.registerFieldType(m,function(e,o,n){t.intercept(n,o,function(e){if(null!==e.newValue&&(("string"==typeof e.newValue||e.newValue instanceof String)&&(e.newValue=Date.parse(e.newValue),isNaN(e.newValue)||(e.newValue=new Date(e.newValue))),!(e.newValue instanceof Date)))throw new Error("Field can be only Date or null.");return e})});var v="boolean";u.registerFieldType(v,function(e,o,n){t.intercept(n,o,function(e){return null!==e.newValue&&(e.newValue=Boolean(e.newValue)),e})}),e.DefaultAdapter=l,e.Model=a,e.boolean=function(e,o){var n="Function"==e.constructor.name?e.prototype.constructor.name:e.constructor.name;u.registerModelField(n,v,o),t.observable(e,o)},e.datetime=function(e,o){var n="Function"===e.constructor.name?e.prototype.constructor.name:e.constructor.name;u.registerModelField(n,m,o,{},function(e){return new Date(e)},function(e){return e.toISOString()}),t.observable(e,o)},e.field=function(e,o){var n="Function"===e.constructor.name?e.prototype.constructor.name:e.constructor.name;u.registerModelField(n,c,o),t.observable(e,o)},e.float=function(e,o){var n="Function"===e.constructor.name?e.prototype.constructor.name:e.constructor.name;u.registerModelField(n,p,o),t.observable(e,o)},e.foreign=function(e){for(var o=[],n=1;n<arguments.length;n++)o[n-1]=arguments[n];return function(n,r){var i=n.getModelName();"function"==typeof e&&(e="Function"==e.constructor.name?e.prototype.constructor.name:e.constructor.name),u.registerModelField(i,d,r,{foreign_model_name:e,foreign_id_field_names:o.length?o:[r+"_id"]}),t.observable(n,r)}},e.id=function(e,o){u.registerModelField(e.getModelName(),s,o),u.registerId(e.getModelName(),o),t.observable(e,o)},e.many=function(e,o){return function(n,r){var i=n.getModelName();"function"==typeof e&&(e="Function"==e.constructor.name?e.prototype.constructor.name:e.constructor.name),u.models[i]||u.registerModel(i),u.models[e]||u.registerModel(e),u.registerModelField(i,"many",r,{remote_model_name:e,foreign_field_on_remote_model:o}),t.observable(n,r),t.observe(u.models[e].objects,function(e){switch(e.type){case"add":t.observe(e.newValue,o,function(t){if(t.oldValue){var o=t.oldValue,n=o[r].indexOf(e.newValue);n>-1&&o[r].splice(n,1)}t.newValue&&t.newValue[r].push(e.newValue)});break;case"remove":var n=e.oldValue[o];if(n){var i=n[r].indexOf(e.oldValue);i>-1&&n[r].splice(i,1)}}})}},e.model=function(e){for(var t=function(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];var n=function(){return e.apply(this,t)};n.__proto__=e.__proto__,n.prototype=e.prototype;var r=e.getModelName(),i=e.getModelDescription(),l=new n,a=l._init_data?l._init_data:{};for(var s in delete l._init_data,i.fields)void 0!==l[s]&&void 0===a[s]&&(a[s]=l[s]);for(var s in i.fields){var c=i.fields[s].type;u.field_types[c](r,s,l)}if(a)for(var s in a)l[s]=a[s];return l},o=0,n=Object.getOwnPropertyNames(e);o<n.length;o++){var r=n[o];null==t[r]&&(t[r]=e[r])}return t.__proto__=e.__proto__,t.prototype=e.prototype,t},e.number=function(e,o){var n="Function"==e.constructor.name?e.prototype.constructor.name:e.constructor.name;u.registerModelField(n,f,o),t.observable(e,o)},e.one=function(e,o){return function(n,r){var i=n.getModelName();"function"==typeof e&&(e="Function"==e.constructor.name?e.prototype.constructor.name:e.constructor.name),u.models[i]||u.registerModel(i),u.models[e]||u.registerModel(e),u.registerModelField(i,"one",r,{remote_model_name:e,foreign_field_on_remote_model:o}),t.observable(n,r);for(var l=function(e){t.observe(e,o,function(t){t.oldValue&&(t.oldValue[r]=null),t.newValue&&(t.newValue[r]=e)})},a=0,s=Object.values(u.models[e].objects);a<s.length;a++)l(s[a]);t.observe(u.models[e].objects,function(e){switch(e.type){case"add":t.observe(e.newValue,o,function(t){t.oldValue&&(t.oldValue[r]=null),t.newValue&&(t.newValue[r]=e.newValue)});break;case"remove":var n=e.oldValue[o];n&&(n[r]=null)}})}},e.store=u,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=mobx-orm.js.map
